- hosts: jenkins_k3s
  become: true
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

    - name: Install base packages
      apt:
        name:
          - docker.io
          - curl
          - git
          - awscli
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - unzip
          - openjdk-17-jre-headless
        state: present
        update_cache: yes

    - name: Ensure docker service is enabled and running
      service:
        name: docker
        state: started
        enabled: yes

    - name: Install k3s
      shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--write-kubeconfig-mode 644 --node-name devops-jenkins" sh -
      args:
        creates: /usr/local/bin/k3s

    - name: Ensure k3s service is enabled and running
      service:
        name: k3s
        state: started
        enabled: yes

    - name: Install kubectl
      shell: |
        set -e
        KUBE_VERSION="v1.29.3"
        curl -LO "https://dl.k8s.io/release/${KUBE_VERSION}/bin/linux/amd64/kubectl"
        install -m 0755 kubectl /usr/local/bin/kubectl
        rm kubectl
      args:
        creates: /usr/local/bin/kubectl

    - name: Install Helm
      shell: |
        set -e
        HELM_VERSION="v3.14.4"
        curl -LO "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz"
        tar -zxvf helm-${HELM_VERSION}-linux-amd64.tar.gz
        install -m 0755 linux-amd64/helm /usr/local/bin/helm
        rm -rf linux-amd64 helm-${HELM_VERSION}-linux-amd64.tar.gz
      args:
        creates: /usr/local/bin/helm

    - name: Add Jenkins apt key
      shell: |
        curl -fsSL https://pkg.jenkins.io/debian/jenkins.io-2023.key | sudo tee /usr/share/keyrings/jenkins-keyring.asc > /dev/null
      args:
        creates: /usr/share/keyrings/jenkins-keyring.asc

    - name: Add Jenkins apt key
      shell: |
        curl -fsSL https://pkg.jenkins.io/debian/jenkins.io-2023.key | sudo tee /usr/share/keyrings/jenkins-keyring.asc > /dev/null
      args:
        creates: /usr/share/keyrings/jenkins-keyring.asc

    - name: Add Jenkins apt repository (manual file)
      copy:
        dest: /etc/apt/sources.list.d/jenkins.list
        content: "deb [signed-by=/usr/share/keyrings/jenkins-keyring.asc] https://pkg.jenkins.io/debian binary/\n"
        mode: "0644"

    - name: Update apt cache for Jenkins repo
      apt:
        update_cache: yes

    - name: Install Jenkins
      apt:
        name: jenkins
        state: present

    - name: Ensure Jenkins service is enabled and running
      service:
        name: jenkins
        state: started
        enabled: yes

    - name: Add jenkins user to docker group
      user:
        name: jenkins
        groups: docker
        append: yes

    - name: Create Jenkins kube config directory
      file:
        path: /var/lib/jenkins/.kube
        state: directory
        owner: jenkins
        group: jenkins
        mode: "0750"

    - name: Copy k3s kubeconfig for Jenkins
      copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: /var/lib/jenkins/.kube/config
        remote_src: yes
        owner: jenkins
        group: jenkins
        mode: "0640"

    - name: Set KUBECONFIG for Jenkins service
      lineinfile:
        path: /etc/default/jenkins
        regexp: "^KUBECONFIG="
        line: "KUBECONFIG=/var/lib/jenkins/.kube/config"
        create: yes

    - name: Restart Jenkins to pick up env changes
      service:
        name: jenkins
        state: restarted
